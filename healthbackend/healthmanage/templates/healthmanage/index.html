{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "dist/css/app.css" %}">
{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }}Home{% endblock %}

{% block content_title %} {% trans 'Home' %} {% endblock %}

{% block breadcrumbs %}
<ol class="breadcrumb">
    <li><a href="{% url 'healthmanage:index' %}"><i class="fa fa-dashboard"></i> {% trans 'Home' %}</a></li>
</ol>
{% endblock %}

{% block content %}

  <!-- Main content -->
  <section class="content">
    {% if request.user.is_superuser %}
    <div class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="box box-success">
          <div class="box-body">
            {% if dataset is None %}   
              <h3>信息不足</h3>
              <h3>无法分析</h3>
            {% endif %}
            <div id="mapBox" style="width: 100%;height: 580px;"></div>
          </div>
          <!-- /.box-body -->
        </div>
      </div>
    </div>    
    {% else %} 
    {% for i in request.user.groups.all %}     
      {% if '个人用户' == i.name %}
      <div class="row">
          <!-- row -->
          <div class="col-md-12">
            <div class="box box-solid">
              <div class="box-header">
                <i class="fa fa-bar-chart-o"></i>

                <h3 class="box-title">吸烟及糖尿病史<small>(%)</small></h3>

                <div class="box-tools pull-right">
                  <button type="button" class="btn btn-default btn-sm" data-widget="collapse"><i class="fa fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-default btn-sm" data-widget="remove"><i class="fa fa-times"></i>
                  </button>
                </div>
              </div>
              <!-- /.box-header -->
              <div class="box-body" >
                
                <div id="smokediabetesChart" style="width: 100%;height:200px;"></div>
                  {% if age %}
                  <h4 class="box-title" style="text-align: center;">年龄：{{age}}岁</h4>
                  {% else %}
                  <h4 class="box-title" style="text-align: center;">信息不足无法显示</h4>
                {% endif %}  
              <!-- /.box-body -->
              </div>
            <!-- /.box -->
          </div>
          <!-- /.col (RIGHT) -->
          </div>
        <!-- /.row -->

      <div class="col-md-12">
          <!-- BAR CHART -->
        <div class="box box-success">
          <div class="box-header with-border">
            <h3 class="box-title">体重指数分析：</h3>
            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
              <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
            </div>
          </div>
          <div class="box-body" >
            <div id="bodyChart" style="width: 100%;height:200px;"></div>
          </div>
          <!-- /.box-body -->
        </div>
      </div>

      <div class="col-md-6">
        <!-- DONUT CHART -->
        <div class="box box-danger">
          <div class="box-header with-border">
            <h3 class="box-title">血压(mmHg)：</h3>

            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
              <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
            </div>
          </div>
          <div class="box-body">
            <div id="BloodPressureChart" style="width: 100%;height:300px;"></div>
          </div>
          <!-- /.box-body -->
        </div>
        <!-- /.box -->
      </div>
      <!-- /.col (RIGHT) -->

      <div class="col-md-6">
        <!-- DONUT CHART -->
        <div class="box box-danger">
          <div class="box-header with-border">
            <h3 class="box-title">血脂(mmol/L)：</h3>

            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
              <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
            </div>
          </div>
          <div class="box-body">
            <div id="BcholesterinChart" style="width: 100%;height:300px;"></div>
          </div>
          <!-- /.box-body -->
        </div>
        <!-- /.box -->
      </div>
      <!-- /.col (RIGHT) -->
    </div>
    <!-- /.row -->

    {% else %}
    <div class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="box box-success">
          <div class="box-body">
            {% if dataset is None %}   
              <h3>信息不足</h3>
              <h3>无法分析</h3>
            {% endif %}
            <div id="mapBox" style="width: 100%;height: 580px;"></div>
          </div>
          <!-- /.box-body -->
        </div>
      </div>
    </div>    
    {% endif %} 
  {% endfor %}
  {% endif %} 
  </section>
  <!-- /.content -->

{% endblock %}
{% block extrajs %}
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="{% static 'plugins/jquery-knob/js/jquery.knob.js' %}"></script>
    <script src="{% static 'dist/js/china.js' %}"></script>
<script>
{% if request.user.is_superuser %}
$(function () {
        // 初始化echarts实例
        let mapBoxEchart = echarts.init(document.getElementById('mapBox'));    
        // 指定相关的配置项和数据
        let mapBoxOption = {
          backgroundColor: '#FFFFFF',
          title: {
            text: '健康管理用户人群分布图',
          //  subtext: '',
            x: 'center',
            y: '8%',
          },
          tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}人'
          },
          toolbox: {
            show: true,
            orient: 'vertical',
            left: 'right',
            top: 'center',
            feature: {
              dataView: { readOnly: false },
              restore: {},
              saveAsImage: {}
            }
          },
          visualMap: {
            min: 0,
            max: {{ valmax }},
            left: 'left',
            top: 'bottom',
            text: ['高', '低'],
            inRange: {
              color: ['lightskyblue', 'yellow', 'orangered']
              //color: ['#e0ffff', '#006edd']
            },
            show: true
          },
          geo: {
            map: 'china',
            roam: false,
            zoom: 1.10,
            label: {
              normal: {
                show: true,
                fontSize: '10',
                color: 'rgba(0,0,0,0.7)',
              }
            },
            itemStyle: {
              normal: {
                borderColor: 'rgba(0, 0, 0, 0.2)',
                areaColor: "#ffefd5", //区域颜色
              },
              emphasis: {
                areaColor: '#F3B329',
                shadowOffsetX: 0,
                shadowOffsetY: 0,
                shadowBlur: 20,
                borderWidth: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          },
          series: [
            {
              name: '用户数',
              type: 'map',
              geoIndex: 0,
              data: {{ dataset | safe }},
            }
          ],
        };
    
        // 使用指定的配置项和数据显示图表。   
        mapBoxEchart.setOption(mapBoxOption);
        window.addEventListener('resize', () => {
          mapBoxEchart.resize()
        })
      });
      {% else %} 
      {% for i in request.user.groups.all %}     
        {% if '个人用户' == i.name %}

 // 顶部百分率圆图
$(function () {
  let dom = document.getElementById('smokediabetesChart');
  let myChart = echarts.init(dom);
  let option = {
          tooltip: {
            formatter: '{a} <br/>{b} : {c}%'
          },
          toolbox: {
            feature: {
              restore: {},
              saveAsImage: {}
            }
          },
          grid: [
            { width: '33%', height: '100%'},
            { width: '33%', height: '100%',left: '33%', },
            { width: '33%', height: '100%',left: '66%', }],
          series: [
            {
              name: '吸烟时长:'+{{smokeyear}}+'年',
              data: [{name: '吸烟',value: {% widthratio smokeyear age 100 %}}],
              type: 'gauge',
              radius: '100%',
              center: ['18%', '50%'],
              axisLine: {lineStyle: { width: 20}},    // 属性lineStyle控制线条样式
              detail: {formatter: {{smokeyear}}+'年'}
            },            
            {
              name: '糖尿病时长:'+{{diabetesyear}}+'年',
              data: [{name: '糖尿病',value: {% widthratio diabetesyear age 100 %} }],
              type: 'gauge',
              center: ['50%', '50%'],
              radius: '100%',
              axisLine: {lineStyle: { width: 20}},    // 属性lineStyle控制线条样式
              detail: {formatter:{{diabetesyear}}+'年'}
            },
            {
              name: '饮酒时长:'+{{drinkyear}}+'年',
              data: [{name: '饮酒',value: {% widthratio drinkyear age 100 %} }],
              type: 'gauge',
              radius: '100%',
              center: ['82%', '50%'],
              axisLine: {lineStyle: { width: 20}},    // 属性lineStyle控制线条样式
              detail: {formatter: {{drinkyear}}+'年'}
            }]
  };
  myChart.setOption(option, true);
  window.addEventListener('resize', () => {
    console.log('resize')
    myChart.resize()
  })
});


//bmi、体重、身高、腰围echartline图
$(function () {
  // 基于准备好的dom，初始化echarts实例
  let myChart = echarts.init(document.getElementById('bodyChart'));
// 指定图表的配置项和数据
  let option = {
    title: [
        {text: '体质指数(BMI)',left:'8%',top:-4},
        {text: '体重',left:'36%',top:-4},
        {text: '身高',left:'61%',top:-4},
        {text: '腰围',left:'86%',top:-4}
      ],
    dataset:{
      source:{% autoescape off %}{{ bddataset }}{% endautoescape %}
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'cross',
            label: {backgroundColor: '#6a7985'}
        }
    },
    legend: {show:false},
    toolbox: {
      feature: {saveAsImage: {}}
    },
    grid: [
        { show:true, top:'10%',bottom:'5%',left: ' 3%',width: '20%', height: '80%'},
        { show:true, top:'10%',bottom:'5%',left: '28%',width: '20%', height: '80%'},
        { show:true, top:'10%',bottom:'5%',left: '53%',width: '20%', height: '80%'},
        { show:true, top:'10%',bottom:'5%',left: '78%',width: '20%', height: '80%'}
    ],
    xAxis:[ 
        {gridIndex: 0,type: 'category'},
        {gridIndex: 1,type: 'category'},
        {gridIndex: 2,type: 'category'},
        {gridIndex: 3,type: 'category'}
    ],
    yAxis:[
        {gridIndex: 0,type: 'value',min:function (value) {return Math.round(value.min) - 2;},max:function (value) {return Math.round(value.max) + 2;}},
        {gridIndex: 1,type: 'value',min:function (value) {return Math.round(value.min) - 5;},max:function (value) {return Math.round(value.max) + 5;}},
        {gridIndex: 2,type: 'value',min:function (value) {return Math.round(value.min) - 5;},max:function (value) {return Math.round(value.max) + 5;}},
        {gridIndex: 3,type: 'value',min:function (value) {return Math.round(value.min) - 2;},max:function (value) {return Math.round(value.max) + 2;}},
    ],
    series: [
        {name:'BMI',type: 'line', seriesLayoutBy: 'row', xAxisIndex: 0,yAxisIndex: 0, encode: {x: 0,y: 4,}},
        {name:'体重',type: 'line', seriesLayoutBy: 'row', xAxisIndex: 1,yAxisIndex: 1, encode: {x: 0,y: 2,}},
        {name:'身高',type: 'line', seriesLayoutBy: 'row', xAxisIndex: 2,yAxisIndex: 2, encode: {x: 0,y: 1,}},
        {name:'腰围',type: 'line', seriesLayoutBy: 'row', xAxisIndex: 3,yAxisIndex: 3, encode: {x: 0,y: 3,}}
    ]
  };

  // 使用指定的配置项和数据显示图表。
  myChart.setOption(option);
  window.addEventListener('resize', () => {
    myChart.resize()
  })
});


//血压
$(function () {
  // 基于准备好的dom，初始化echarts实例
  let myChart = echarts.init(document.getElementById('BloodPressureChart'));
// 指定图表的配置项和数据
  let option = {
    title: {
        text: '血压',
        show:false
    },
    dataset:{
      source:{% autoescape off %}{{ bpdataset }}{% endautoescape %}
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'cross',
            label: {
                backgroundColor: '#6a7985'
            }
        }
    },
    legend: {},
    toolbox: {
        feature: {
            saveAsImage: {}
        }
    },
    grid: {
        left: '5%',
        right: '7.5%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: {type: 'category',boundaryGap: false,},
    yAxis: {},
    series: [
        { name:'收缩压',
          type: 'line', 
          seriesLayoutBy: 'row',
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                offset: 0,color: '#AA0022'   //上部颜色
                }, {
                offset: 1,color: '#FFFFFF'   //下部颜色
                }])
          },
        },
        {name:'舒张压',type: 'line', seriesLayoutBy: 'row',areaStyle: {color: '#FFFFFF',opacity:0.6},},
        {name:'心率',type: 'line', seriesLayoutBy: 'row'}
    ]
  };

  // 使用指定的配置项和数据显示图表。
  myChart.setOption(option);
  window.addEventListener('resize', () => {
    myChart.resize()
  })
});

//血脂
$(function () {
  // 初始化echarts实例
  let myChart = echarts.init(document.getElementById('BcholesterinChart'));

// 设置图表的配置项和数据
  let option = {
    title: {
        text: '血脂',
        show:false
    },
    dataset:{
      source:{% autoescape off %}{{ bsdataset }}{% endautoescape %}
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'cross',
            label: {
                backgroundColor: '#6a7985'
            }
        }
    },
    legend: {},
    toolbox: {
        feature: {
            saveAsImage: {}
        }
    },
    grid: {
        left: '5%',
        right: '7.5%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: {type: 'category',boundaryGap: false,},
    yAxis: {},
    series: [
        { name:'总胆固醇',
          type: 'line', 
          seriesLayoutBy: 'row',
          areaStyle: {
            color:'#60acfc',opacity:0.5   
          }
        },
        { name:'低密度',
          type: 'line', 
          seriesLayoutBy: 'row',
          areaStyle: {
            color:'#feb64d',opacity:0.5  
          }
        },
        { name:'高密度',
          type: 'line', 
          seriesLayoutBy: 'row',
          areaStyle: {
            color:'#5bc49f',opacity:0.5  
          }
        },
        { name:'甘油三酯',
          type: 'line', 
          seriesLayoutBy: 'row',
          areaStyle: {
            color:'#ff7c7c',opacity:0.5  
          }
        }
    ]
  };

  // 使用指定的配置项和数据显示图表。
  myChart.setOption(option);
  window.addEventListener('resize', () => {
    myChart.resize()
  })
});
{% else %} 
$(function () {
        // 初始化echarts实例
        let mapBoxEchart = echarts.init(document.getElementById('mapBox'));    
        // 指定相关的配置项和数据
        let mapBoxOption = {
          backgroundColor: '#FFFFFF',
          title: {
            text: '健康管理用户人群分布图',
          //  subtext: '',
            x: 'center',
            y: '8%',
          },
          tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}人'
          },
          toolbox: {
            show: true,
            orient: 'vertical',
            left: 'right',
            top: 'center',
            feature: {
              dataView: { readOnly: false },
              restore: {},
              saveAsImage: {}
            }
          },
          visualMap: {
            min: 0,
            max: {{ valmax }},
            left: 'left',
            top: 'bottom',
            text: ['高', '低'],
            inRange: {
              color: ['lightskyblue', 'yellow', 'orangered']
              //color: ['#e0ffff', '#006edd']
            },
            show: true
          },
          geo: {
            map: 'china',
            roam: false,
            zoom: 1.10,
            label: {
              normal: {
                show: true,
                fontSize: '10',
                color: 'rgba(0,0,0,0.7)',
              }
            },
            itemStyle: {
              normal: {
                borderColor: 'rgba(0, 0, 0, 0.2)',
                areaColor: "#ffefd5", //区域颜色
              },
              emphasis: {
                areaColor: '#F3B329',
                shadowOffsetX: 0,
                shadowOffsetY: 0,
                shadowBlur: 20,
                borderWidth: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          },
          series: [
            {
              name: '用户数',
              type: 'map',
              geoIndex: 0,
              data: {{ dataset | safe }},
            }
          ],
        };
    
        // 使用指定的配置项和数据显示图表。   
        mapBoxEchart.setOption(mapBoxOption);
        window.addEventListener('resize', () => {
          mapBoxEchart.resize()
        })
      });
{% endif %} 
{% endfor %}
{% endif %} 
</script>

{% endblock %}
